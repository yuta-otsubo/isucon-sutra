# ISUCON14 当日マニュアル

## スケジュール

- 10:00: 競技開始
- 17:00: リーダーボードの更新停止
- 18:00: 競技終了
- 19:30: 結果発表（予定）

## アプリケーション ISURIDEについて

<!-- TODO（公開前）: URLの張り替え -->

ISURIDEの仕様については[ISURIDE アプリケーションマニュアル](./ISURIDE.md)を参照してください。

## ISUCON14 ポータルサイト（ポータル）について

ISUCON14の競技では下記のウェブサイトを利用します。事前に登録した情報を用いてログインしてください。
なお、このページは競技開始時刻までアクセスすることはできません。

https://portal.isucon.net/contestant

ポータルでは、負荷走行（ベンチマーク）の実行/結果確認、質問/サポート依頼の送信、リーダーボードの確認ができます。

### リーダーボードの更新について

ポータル上のリーダーボードは、競技終了1時間前に他チームの情報が更新されなくなり、自チームの情報のみ更新されるようになります。

## Discordの利用について

ISUCON14のDiscordサーバーは競技中ならびにその前後の時間はすべてのチャンネルが発言不可となります。競技時間中はポータルを通して質問/サポート依頼を送信することができますので、そちらを利用してください。

ただし、予選参加者（以下、選手）は競技時間中もDiscordの確認が可能な状態、通知が受け取れる状態を維持してください。 これは主催者が選手とリアルタイムでのチャットが必要だと判断した場合、主催者がDiscord上でプライベートチャンネルを作成しメンションの上、呼びかけを行う場合があるためです。呼びかけに応じない場合、競技に支障をきたす可能性があるため、必ず応答可能な状態を維持してください。

また、主催者からのアナウンス等もDiscordで実施されます。

## 質問について

選手は主催者へ質問を送信することができます。質問は競技内容・マニュアル・レギュレーション等に対する疑問点の確認や、サーバー障害などのトラブル報告・サポート依頼に利用することができますが、これに限りません。

主催者は質問された内容が競技の一環である場合は、回答できない旨を返答することがあります。

競技時間中の質問について、主催者からの回答は全選手へ公開、あるいは個別に回答されます。全選手へ公開される場合、質問内容の原文、あるいは主催者による内容の要約が公開されます。未回答の質問・未公開の回答については質問した選手およびそのチームメンバー、主催者のみが確認できます。質問への回答・更新はポータル上にて選手およびそのチームへ通知されます。

主催者は競技時間中の質問への回答を、原則として全選手へ公開します。ただし、重複する質問や、選手およびチーム個別の問題に対する対応の場合、この限りではありません。

## サポート対象外の事項

主催者が事前にDiscordサーバー等で告知していた通り、下記はサポート対象外となります。

- 競技環境確認を事前に行っていないチームからの競技環境に関する質問/サポート依頼
- AWS及びAWSクーポンに関する質問/サポート依頼

## 競技環境構築と接続

競技に参加するにあたり、各チームが用意したAWSアカウントで競技環境を下記の手順に従って構築してください。

### 1. テンプレートのダウンロード

まず、環境構築にはAWS CloudFormationを利用するため、チームはポータル上からAWS CloudFormationのテンプレートをダウンロードします。 テンプレートはチームごとに固有のものとなっているため共有厳禁です。

[https://portal.isucon.net/contest/](https://portal.isucon.net/contest/)

このテンプレートでは以下のリソースを作成します。

- EC2サーバー（c5.large）x 3
- EBS（gp3 20GB）x 3
- EIP x 3
- VPC x 1
- VPCサブネットx 1
- VPCルートテーブルx 1
- インターネットゲートウェイx 1
- セキュリティグループx 1
- Availability Zone情報取得に利用するLambda関数x 1
- IAMロールx 2
- EC2インスタンスプロファイルx 1

テンプレートから作成されるIAMロールは、EC2サーバーおよびLambda関数で上記リソースの情報取得を行うために利用します。 許可されているアクションはAWSの仕様上、アカウントに存在する他のリソースの情報も閲覧できる設定になっていますが、主催者は不要な情報の取得は行いません。

### 2. スタックの作成

1. [AWSマネジメントコンソールのCloudFormation](https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1)を開き、ページ右上に表示されている **リージョン名がアジアパシフィック（東京）（ap-northeast-1）** になっていることを確認します。
2. 「スタックの作成」をクリックします。 既存のスタックがある場合は「スタックの作成」から「新しいリソースを使用（標準）」を選択します。3.「スタックの作成」ページから「前提条件 - テンプレートの準備」で「既存のテンプレートを選択」、「テンプレートの指定」で「テンプレートファイルのアップロード」を選択し、上記でダウンロードしたテンプレートファイルのアップロードを行い「次へ」をクリックします。4.「ステップ2スタックの詳細を指定」では任意のスタック名 (`isucon14`) を設定し、「次へ」をクリックします。5.「ステップ3スタックオプションの設定」では変更を行わず「次へ」をクリックします。6.「ステップ4レビュー」において、ページ最下部「スタックの作成」ボタンの上に表示されている「AWS CloudFormationによってIAMリソースが作成される場合があることを承認します」にチェックを入れた上で、「スタックの作成」をクリックします。
3. 作成したスタックの状態が `CREATE_COMPLETE`（作成完了）になるまで待機します。（数分かかります）

上記はマネジメントコンソールが「日本語」の場合の手順です。他の言語の場合も同様の手順に従ってください。

### 3. サーバーへの SSH 接続

スタックの作成完了後、数分程度でSSH接続できるようになります。サーバーには選手がGitHubに登録しているSSH鍵を利用して、ユーザー名`isucon`でSSH接続ができます。

また、AWSマネージメントコンソールからセッションマネージャーによる接続も可能です。セッションマネージャーで接続した場合は`ssm-user`というユーザーになるため、`sudo su - isucon` でisuconユーザーに切り替えてください。

サーバーのIPアドレスはポータルか、AWSマネジメントコンソールのEC2サーバーページから確認できます。

サーバーへ接続後、下記のコマンドを実行することで正しく起動しているか検証が行えます。

```sh
$ sudo /opt/isucon-env-checker/envcheck
```

サーバー起動後にポータルのサーバーリストに表示されない場合は、サーバーにSSH（またはセッションマネージャ）ログインし、上記`envcheck`コマンドを実行し、詳細を確認してください。

## アプリケーションの動作確認

ISURIDE には、サーバーのWeb ブラウザから HTTPS でアクセスできます。

### 動作確認のためのhostsファイル設定

ISUPORTSはホスト名に依存した挙動があるため、ブラウザにサーバーのIPアドレスを直打ちする形での閲覧はできません。以下の手順でhostsファイルを編集し、動作確認のためのホスト名が競技サーバーのIPアドレスにつながるようにします。

Mac や Linux であれば `/etc/hosts` に、 Windows であれば `C:\Windows\System32\drivers\etc\hosts` に以下の行を追記します。`${サーバー IP アドレス}` はサーバーの IP アドレスに読み替えてください。

```
${サーバー IP アドレス} isuride.xiv.isucon.net
```

上記変更の反映にはブラウザの再起動が必要な場合があります。

### ISURIDEへのログイン

<!-- TODO: 書く -->

## ベンチマーカーの実行

負荷走行はポータル上からリクエストします。

ポータルにアクセスし、「Job Enqueue Form」からベンチマーク対象のサーバーを選択、「Enqueue」をクリックすることで負荷走行のリクエストが行われ、順次開始されます。

なお、負荷走行が待機中（`WAITING`）もしくは実行中（`RUNNING`）の間は追加でリクエストを行うことはできません。

<!-- TODO: タイムアウト時間の確認 -->

ベンチマーカーが不正に終了した場合、結果がすぐに表示されない場合があります。

## 競技環境について

### 環境情報の確認と送信

サーバー起動（再起動を含む）時に競技環境が主催者の指定した環境で構築されているかを確認し、サーバーのIPアドレスを含む環境情報をポータルに送信する処理が実行されます。

ポータルは送信された環境情報を元に、ポータル上に表示されるサーバー IPアドレス等のサーバー情報を更新します。なお、これはサーバー単位で更新されます。

この処理はサーバー起動時以外に、以下のコマンドで選手自らが行えます。

```sh
$ sudo /opt/isucon-env-checker/envcheck boot
```

<!-- TODO:環境チェックにfailしても登録されてた気がする。要確認 -->

サーバー環境のセットアップに修正が必要な事項があれば、登録はされません。

### 競技環境の再構築方法

選手自らが設定変更等により競技環境を破壊するなどして、初期状態に戻す必要がある場合は上記「競技環境構築と接続」を参考に自らAWS CloudFormationで新たに競技環境の構築を行ってください。再構築以前の競技環境上で変更を加えたソースコードや設定ファイル等の移行は、各チームの責任で行う必要があります。

なお、サーバーインスタンスの起動・停止・再起動はAWSマネジメントコンソールやAPIから選手が行っても構いません。

後述する「複数スタック」の問題を回避するため、再構築作業完了後は以前のAWS CloudFormationスタックを削除することをおすすめします。

### サーバーリストへの登録について

サーバーリストはチームあたり最大3台までの登録となります。以前のサーバーが一覧に残っていると再構築後のサーバーは登録されません。

再構築を行う際は、作業開始前にサーバーリストから削除してください。

<!-- TODO: envcheck叩かせたほうが良くない？ -->

もし再構築を先に行なってサーバーが追加されない場合は、サーバーリストから使用しないサーバーを削除し、全ての新しいサーバーインスタンスの再起動を行なってください。サーバー情報の更新はサーバーインスタンスが起動（再起動を含む）された際に行われます。

### 複数スタックについて

ポータルからダウンロードしたテンプレートを利用してAWS CloudFormationスタックを複数作成しても構いません。ただし、以下の点に留意してください。

まず、「環境情報の確認と送信」で言及した通り、サーバー情報の更新はサーバー単位、かつサーバーインスタンスが起動（再起動を含む）するたびに実施されます。 そのため、複数のスタックで作成されたサーバーが同時に存在している時、選手の操作によっては、ポータル上のサーバー情報が複数のスタックに跨ってしまう場合（混在）があります。

競技時間中は混在した状態になってしまっても問題ありませんが、競技終了時点でポータル上のサーバー情報が混在していた場合は失格となります。

主催者はポータルに登録された環境以外のサポートや、混在した状態でのサポートは行いません。

なお、混在しているかの判断はポータルとスタックのリソースに表示されているIPアドレスを元に行ってください。

### 競技環境の変更について

選手が競技を進めるにあたって新たなポート解放が必要な場合、セキュリティグループの変更は行なっても構いません。

ただし、SSH(TCP/22)、HTTPS(TCP/443)については競技に影響があるため変更しないでください。

上記セキュリティグループの変更により、ベンチマークが実行できない場合は失格となります。

### 重要事項

- 競技終了後は主催者からアナウンスがあるまで競技環境のシャットダウンや停止などは行わず、3台とも起動した状態を維持してください。
  - 競技時間中の再起動や一時的な停止に関しては問題ありません。
- 競技に利用できる計算機資源は主催者が公開したCloudFormationテンプレートの内容に沿って起動されたEC2インスタンスのみです。
  - 例えば、テンプレートで作成されたリソースを、その内容に沿わなくなる変更（例： インスタンスタイプの変更）を行った状態で、競技に利用すると失格となります。
  - 競技終了時点で環境情報の確認に失敗する状態の場合、失格となります。
  - 競技終了時点でポータル上のサーバー情報に複数環境（スタック）が混在した状態の場合、失格となります。
  - レギュレーションに記載した通り、モニタリングやテスト、開発において外部の資源を用いても構いませんが（例： メトリクス計測サービス）、スコアを向上させるいかなる効果を持つものであってはいけません。これは前述している複数環境の利用も含みます。
- 競技終了後は、主催者が追試を行います。Discordサーバー および https://isucon.net にて主催者がアナウンスをするまで、競技環境の操作はしないでください。
  - 競技終了後、別途アナウンスがあるまでの作業や操作（削除を含む）は失格となります。なお、アナウンスは結果発表後の予定です。
  - 競技環境の削除は、各チームで行う必要があります。削除を行わなかったために発生した不利益について、主催者は一切の責任を負いません。削除を行ってよいタイミングについても、結果発表後にアナウンスの予定です。

#### 変更してはいけない点

下記は追試や環境確認に利用するため、変更した場合は失格となります。

<!-- TODO: 要確認 -->

- envcheck.serviceに関わるファイル
  - `/etc/systemd/system/envcheck.service`
  - `/etc/systemd/system/multi-user.target.wants/envcheck.service`
  - `/opt/isucon-env-checker` 内のファイル、バイナリファイル
- isuadminユーザーに関わるファイル・権限およびログイン情報
- その他、主催者による追試を妨げる変更（例： サーバー上のisucon以外のユーザーに関する、ユーザー削除や既存の公開鍵の削除、サーバーの再起動の妨害）

## 参考実装

下記の言語での実装が提供されています。

- Go
- Node.js
- Perl
- PHP
- Python
- Ruby
- Rust

### 参考実装の切り替え方法

初期状態ではGoによる実装が起動しています。

各言語実装はsystemdで実行、管理されています。 参考実装をGoから他の言語に切り替えるには以下手順を実行します。

#### 1. isuride-go.service を停止、無効化します

```sh
$ sudo systemctl stop isuride-go.service
$ sudo systemctl disable isuride-go.service
```

以下のコマンドでstopとdisableを両方行うことができます。

```sh
$ sudo systemctl disable --now isuride-go.service
```

#### 1. isuride-{各言語}.service を起動、有効化します

`{各言語}` のところにはperlやrubyなどlowercaseの言語名がはいります。

```sh
$ sudo systemctl start isuride-{各言語}.service
$ sudo systemctl enable isuride-{各言語}.service
```

以下のコマンドでstartとenableを両方行うことができます。

```sh
$ sudo systemctl enable --now isuride-{各言語}.service
```

#### PHPへの切り替え

ただし、PHPを使う場合のみ、systemdの設定変更の他に、次のようにnginxの設定ファイルの変更が必要です。

```sh
$ sudo ln -s /etc/nginx/sites-available/isuride-php.conf /etc/nginx/sites-enabled/
$ sudo systemctl restart nginx.service
```

## データベース(MySQL)について

初期実装ではデータベースとしてMySQLを利用しています。

### MySQLへのログイン方法

参考実装のMySQLに管理者権限で接続するには以下のようにします。

```sh
$ sudo mysql {データベース名}
```

### データベースのデータの初期化

参考実装では、初期化処理（`POST /api/initialize`）においてデータベースのデータをベンチマーカーが想定している状態に戻します。以下のコマンドでもデータベースのデータを初期化できます。

```sh
$ ~/webapp/sql/init.sh
```

初期化処理は用意された環境内で、ベンチマーカーが要求する範囲の整合性を担保します。 サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。

### `isuride`データベースのスキーマについて

`isuride`データベースのスキーマは初期実装に含まれています。

- `webapp/sql/0-init.sql`: データベースおよびユーザーの作成
- `webapp/sql/1-schema.sql`: 各種テーブルの作成
- `webapp/sql/2-master-data.sql`: マスターデータの作成
- `webapp/sql/3-initial-data.sql.gz`: 初期データ

`isuride`データベースを初期化するにはデータベースを`DROP DATABASE isuride`および`CREATE DATABASE isuride` で再作成し、以下のコマンドでテーブルの作成を行ったのち、データの初期化を行なってください。

```sh
$ cat webapp/sql/1-schema.sql | sudo mysql isuride
```

<!-- TODO: 要確認 -->

## TLS証明書について

サーバーには `*.xiv.isucon.net` のTLS証明書が設定されています。

このホスト名でHTTPS接続を行うとTLS証明書の検証エラーは発生しません。ベンチマーカーはこれを期待します。

## 負荷走行について

ベンチマーカーによる負荷走行は以下のように実施されます。

- 初期化処理の実行
  - POST /api/initialize（30秒でタイムアウト）
  - POST /api/owner/owners（複数回実行、1リクエスト10秒、全体で20秒でタイムアウト）
  - POST /api/chair/chairs（複数回実行、1リクエスト10秒、全体で20秒でタイムアウト）
  - POST /api/user/users（複数回実行、1リクエスト10秒、全体で20秒でタイムアウト）
- アプリケーション整合性チェック（数秒～数十秒）
- 負荷テスト（60秒）
- 最終チェック（数秒～数十秒）

初期化処理もしくはアプリケーション整合性チェックに失敗すると、負荷走行は即時失敗（fail）になります。

負荷テスト終了時点でHTTPレスポンスの処理を打ち切ります。未完了のリクエストなどは強制的に切断されます。負荷テスト終了以降に強制的に切断されたリクエストはスコア、検証には影響しません。

負荷テスト終了時点で行われていた決済処理は負荷テスト終了後5秒以内に完了する必要があります。5秒以内に完了しなかった場合、ベンチマーカーの期待する決済金額と一致せずfailになります。

### ベンチマーカーのタイムアウトについて

ベンチマーカーのクライアントのタイムアウトはそれぞれ以下のように設定されています。

- 初期化処理の実行： 30秒
- `GET /api/app/notification`, `GET /api/chair/notification`： 60秒
- それ以外のリクエスト： 10秒

### 負荷走行の打ち切り

ベンチマーカーによる負荷走行は以下の状況で打ち切られます。
打ち切られた場合はその負荷走行はFailedとして記録されます。

- 初期化処理の実行時にエラーが発生する
- アプリケーション整合性チェックの実行時にエラーが発生する
- 負荷テストの実行時にクリティカルエラーが発生する

また、負荷テスト中のクリティカルエラーは以下の種類があります。

- 椅子の座標送信に失敗しました
- 椅子が出発できませんでした
- 椅子がライドを受理できませんでした
- ユーザーのライド評価に失敗しました
- ユーザーがライド履歴の取得に失敗しました
- ユーザーが新しくライドを作成できませんでした
- ユーザーが想定していない通知を受け取りました
- 椅子が想定していない通知を受け取りました
- ユーザーに想定していないライドの状態遷移の通知がありました
- 椅子に想定していないライドの状態遷移の通知がありました
- 椅子がアクティベートに失敗しました
- 椅子がライドの完了通知を受け取る前に、別の新しいライドの通知を受け取りました
- ユーザー登録に失敗しました
- オーナー登録に失敗しました
- 椅子登録に失敗しました
- 通知APIの接続に失敗しました
- ユーザーの支払い情報の登録に失敗しました
- オーナーの売り上げ情報の取得に失敗しました
- ユーザーに誤った金額が請求されました
- 取得したオーナーの売り上げ情報が想定しているものと異なります
- オーナーの椅子一覧の取得に失敗しました
- 取得したオーナーの椅子一覧の情報が想定しているものと異なります
- 取得した付近の椅子情報が古すぎます
- アサインされたライドがベンチマーカー外で作られたものであるため処理できません

<!-- TODO: 要検討 -->

### 反映までの猶予時間について

一部APIのデータはリクエストへの反映までに許容される猶予時間があります。

[ISURIDE アプリケーションマニュアル](./ISURIDE.md)を参照してください。

## スコア計算

スコアは1回の負荷走行中のISURIDEの売上の総額の合計/100となります。

スコアの合計額がサーバーとベンチマーカーとで差分がある場合、ベンチマーカーで計測している値をスコアとします。

### 特別賞

<!-- TODO: 後で決める -->

競技中のスコアが、最初にXXX点に到達した1チームを特別賞とします。

### 言語賞

`POST /api/initialize` レスポンスで出力された言語情報を元に、Go・PHP・Python・Rubyで参加したチームのうち最も高いスコアを出したチームに言語賞を授与します。

`POST /api/initialize`のレスポンスには正確に実装に利用した言語を出力してください。

言語賞該当チームには確認のために、ソースコードの提出を求める可能性があります。

### 企業賞

各企業賞の受賞条件は、競技終了後に主催者が発表します。

### 最終スコア

<!-- TODO: 決める -->

競技中の最終計測を最終スコアとします。以下に述べる追試でfailになったチームを取り除いた最終スコアに基づいて順位を決定します。

#### 追試

<!-- TODO: 決める -->

競技終了後、主催者は**全サーバーの再起動後に負荷走行を実施し再現スコアを計測**します。主催者による確認作業（追試）を行います。下記の点にあてはまる場合の最終スコアはfailとします。

##### 全チームに対して行う追試項目

<!-- TODO: 決める -->

- 再起動後の負荷走行でfailした場合
- 再現スコアが最終スコアの75%以下の場合
- envcheckを利用したサーバー環境の確認

##### 最終スコアで上位のチームに対して行う追試項目

- 負荷走行実行時にアプリケーションに書き込まれたデータが、サーバー再起動後に取得できない場合

##### POST /api/initialize での実装言語の出力

`POST /api/initialize`レスポンスにて、本競技で利用した言語を出力してください。参考実装はそのようになっています。この情報は集計しISUCON公式Blogでの公表や、言語賞の判定として利用します。

`POST /api/initialize`のレスポンスは以下のようなJSONとなります。

```json
{
  "lang": "実装言語"
}
```

`lang` の値が実装に利用した言語となります。 `lang` が空の場合は初期化処理が失敗と見なされます。

## 禁止事項

以下の行為を特に禁止とします。

- 競技終了時間までに、競技の内容に関するあらゆる事項（問題内容・計測ツールの計測方法など）を公開・共有すること（内容を推察できる発言も含む）
  - 不特定多数への公開はもちろん、他チームの選手と連絡を取り、問題内容等を共有する事（結託行為）も禁止とする。
  - ただし主催者がX（旧Twitter）, Webサイトにおいて公開している情報は除く。ポータルでログインを要するページ（選手が参加するDiscordを含む）において記載されている内容は公開情報でない旨留意すること
- 競技時間中、チーム外の人物とISUCON14問題にまつわる事項のやりとり（ISUCON14選手であるかどうかを問わない、SNSでの発言も含む）
- 主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為（他のサーバーに処理を委譲するなど）は禁止する。
  - モニタリングやテスト、開発などにおいては、PCや外部のサーバーを利用しても構わない。
  - AIによるコード分析、生成に必要なサービスは利用しても構わない
  - デプロイのために外部のコンテナレジストリ（Amazon ECRなど）を利用することも可能。ただし、競技終了まで他のチームに対して公開されないように注意すること
- 選手が主催者からその選手が属するチームへ提供されていないサーバーについて直接のアクセスを試みる行為や、外部への不正アクセスを試みる行為。具体的にはベンチマーカーへのログイン試行等。（なお、例示のため、これに限らない）
- 他チームと結託する行為（程度を問わず）
- 主催者が他チームへの妨害、競技への支障となるとみなす全ての行為
- 本マニュアルやレギュレーション、ポータルにおいて禁止とされた行為（禁止事項）への違反は、失格とする。
